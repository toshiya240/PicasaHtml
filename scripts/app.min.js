(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}};k=null,j=null,l=null,$(document).on("pagecreate","#main",function(){var a;return a=ko.observableArray(),j=new b,k=new f(j,a),l=new i(a)}),$(document).on("pageinit","#main",function(){return ko.applyBindings(k,document.getElementById("main"))}),$(document).on("pageshow","#main",function(){var a;return"Textwell"===c?(window.location.href="textwell:///webdelegate?init",$("#source-container").hide()):$("#twbutton").hide(),"Mobile Safari"!==c&&"iOS in-app"!==c&&$("#safari-buttons").hide(),a=j.userId(),""===a?k.showSettings():k.getAlbums(a)}),$(document).on("pageinit","#conf",function(){return ko.applyBindings(j,document.getElementById("conf"))}),$(document).on("pageinit","#result",function(){return ko.applyBindings(l,document.getElementById("result"))}),c=function(){var a,b,c,d,e;return d=navigator.userAgent,b=-1!==d.indexOf("Mobile"),c=-1!==d.indexOf("Safari"),a="",b&&c?a="Mobile Safari":b?(e=window.location.href.split("?")[1],a="textwell"===e?"Textwell":"iOS in-app"):a=c?"Safari":"Automator",a}(),m=function(a){var b;return $("#error-msg").text(a),b=$("<a href='#error-page' data-rel='dialog'></a>"),b.get(0).click(),b.remove()},n={set:function(a,b){return this.remove(a),window.localStorage.setItem(a,JSON.stringify(b))},get:function(a){var b;return b=window.localStorage.getItem(a),null!=b?JSON.parse(b):""},remove:function(a){return window.localStorage.removeItem(a)},clear:function(){return window.localStorage.clear()}},d=function(){function a(a,b,c){this.name=a,this.readonly=null!=c?c:!0,this.value=ko.observable(b)}return a}(),h=function(){function a(a,b){this.name=a,this.value=b}return a}(),b=function(){function a(){this.insertPlaceholder=o(this.insertPlaceholder,this),this.copyPresetToCustom=o(this.copyPresetToCustom,this),this.save=o(this.save,this),this.load=o(this.load,this),this.discard=o(this.discard,this),this.finish=o(this.finish,this),this.customIsSelected=o(this.customIsSelected,this),this.userId=ko.observable(""),this.customFormat=new d("カスタム","",!1),this.availableFormats=[new d("写真のみ(インライン)","<img class='picasa_photo' src='${imgURL}' alt='${title}' width='${width}' height='${height}' />"),new d("写真のみ(ブロック)","<p><img class='picasa_photo' src='${imgURL}' alt='${title}' width='${width}' height='${height}' /></p>"),new d("cite付き(ブロック)","<p><img class='picasa_photo' src='${imgURL}' alt='${title}' width='${width}' height='${height}' /><br /><cite>${title} Photo by ${nickname}</cite></p>"),new d("説明付き(ブロック)","<p>${description}<br /><img class='picasa_photo' src='${imgURL}' alt='${title}' width='${width}' height='${height}' /></p>"),this.customFormat],this.selectedFormat=ko.observable(),this.placeholders=[new h("Picasa 上のニックネーム","${nickname}"),new h("タイトル","${title}"),new h("画像のURL","${imgURL}"),new h("画層の幅","${width}"),new h("画像の高さ","${height}"),new h("画像の説明","${description}")],this.load()}return a.prototype.customIsSelected=function(){return"カスタム"===this.selectedFormat().name},a.prototype.finish=function(){return this.save()?$.mobile.changePage("#main",{transition:"flip",reverse:!0}):void 0},a.prototype.discard=function(){return this.load(),$.mobile.changePage("#main",{transition:"flip",reverse:!0})},a.prototype.load=function(){var a,b;return this.userId(n.get("conf_picasahtml_user")),this.customFormat.value(n.get("conf_picasahtml_fmt_custom")),a=null!=(b=n.get("conf_picasahtml_fmt_index"))?b:0,this.selectedFormat(this.availableFormats[a])},a.prototype.save=function(){return""===this.userId()?(m("ユーザID を入力してください。"),!1):(n.set("conf_picasahtml_user",this.userId()),n.set("conf_picasahtml_fmt_custom",this.customFormat.value()),n.set("conf_picasahtml_fmt_index",this.availableFormats.indexOf(this.selectedFormat())),!0)},a.prototype.copyPresetToCustom=function(){return this.customFormat.value(this.selectedFormat().value()),m("現在選択しているプリセットの内容を「カスタム」にコピーしました。")},a.prototype.insertPlaceholder=function(a){var b,c,d,e,f;return e=a.value,d=this.selectedFormat().value(),b=$("#format").get(0),f=b.selectionStart,c=f+e.length,this.selectedFormat().value(d.substr(0,f)+e+d.substr(f)),b.setSelectionRange(c,c),b.focus()},a}(),$(document).on("pagebeforeshow","#conf",function(){return $("#preset").selectmenu("refresh")}),e=function(){function a(a,b){this.name=a,this.value=b,null==this.value&&(this.value=this.name)}return a}(),f=function(){function b(a,b){this.config=a,this.htmlArray=b,this.getPhotos=o(this.getPhotos,this),this.getAlbums=o(this.getAlbums,this),this.showSettings=o(this.showSettings,this),this.picasa=new g,this.albums=ko.observableArray([]),this.selectedAlbum=ko.observable(),this.maxResults=ko.observable(20),this.imgmax=[new e("オリジナル","d"),new e("94"),new e("110"),new e("128"),new e("200"),new e("220"),new e("288"),new e("320"),new e("400"),new e("512"),new e("576"),new e("640"),new e("720"),new e("800"),new e("912"),new e("1024"),new e("1152"),new e("1280"),new e("1440"),new e("1600")],this.selectedImgmax=ko.observable(),this.tag=ko.observable("")}return b.prototype.showSettings=function(){return $.mobile.changePage("#conf",{transition:"flip"})},b.prototype.getAlbums=function(){var b,c,d,e;return $.mobile.loading("show"),e=this.picasa.getAlbums(this.config.userId()),b=e.albums,d=e.status,c=e.error,$.mobile.loading("hide"),null!=c?m(""+d+":"+c+"(1)"):0===b.length?m("No Albums."):(b.unshift(new a("All Albums","")),this.albums(b))},b.prototype.getPhotos=function(){var a,b,c,d;return $.mobile.loading("show"),d=this.picasa.getPhotos(this.config.userId(),this.selectedAlbum().id,this.config.selectedFormat().value(),this.maxResults(),this.selectedImgmax().value,this.tag()),b=d.htmlArray,c=d.status,a=d.error,$.mobile.loading("hide"),null!=a?m(""+c+":"+a+"(3)"):0===b.length?m("No Photos."):(this.htmlArray(b),$.mobile.changePage("#result",{transition:"pop"}))},b}(),a=function(){function a(a,b){this.title=a,this.id=b}return a}(),g=function(){function b(){this.getAlbums=o(this.getAlbums,this)}return b.prototype.picasaUrlBase="http://picasaweb.google.com/data/feed/api/user/",b.prototype.getAlbums=function(b){var c,d,e,f;return f=""+this.picasaUrlBase+b+"?kind=album&alt=json",c=[],e="",d=null,$.ajax({type:"GET",dataType:"json",async:!1,url:f,cache:!1,success:function(b){var d,e,f,g,h,i,j;if(f=b.feed.entry,f.length){for(j=[],h=0,i=f.length;i>h;h++)e=f[h],g=e.title.$t,d=e.gphoto$id.$t,j.push(c.push(new a(g,d)));return j}},error:function(a,b,c){return e=b,d=c}}),{albums:c,textStatus:e,errorThrown:d}},b.prototype.getPhotos=function(a,b,c,d,e,f){var g,h,i,j,k;return g=d,""===b?""===d&&(g=d="20"):(""===d&&(g="1000"),d="1000"),k=""+this.picasaUrlBase+a,""!==b&&(k+="/albumid/"+b),k+="?kind=photo&alt=json&access=public&imgmax="+e+"&max-results="+d,""!==f&&(k+="&tag="+encodeURIComponent(f)),i=[],j="",h=null,$.ajax({type:"GET",dataType:"json",async:!1,url:k,cache:!1,success:function(a){var d,e,f,h,j,k,l,m,n,o,p,q,r,s;if(k=a.feed.entry,k&&k.length){for(""===b&&(k=k.reverse()),m=0,g<k.length&&(m=k.length-g),s=[],h=q=m,r=k.length;r>=m?r>q:q>r;h=r>=m?++q:--q)n=k[h].media$group.media$title.$t,d=k[h].media$group.media$content[0],j=d.url,o=d.width,f=d.height,l=k[h].media$group.media$credit[0].$t,e=k[h].media$group.media$description.$t,e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/"/g,"&quot;"),e=e.replace(/\n/g,"<br />\n"),p=String(c),p=p.replace(/\${title}/g,n),p=p.replace(/\${imgURL}/g,j),p=p.replace(/\${width}/g,o),p=p.replace(/\${height}/g,f),p=p.replace(/\${nickname}/g,l),p=p.replace(/\${description}/g,e),s.push(i.push(""+p+"\n\n"));return s}},error:function(a,b,c){return j=b,h=c}}),{htmlArray:i,status:j,error:h}},b}(),i=function(){function a(a){this.htmlArray=a,this.insertToTextwell=o(this.insertToTextwell,this),this.sendToTextHandler=o(this.sendToTextHandler,this),this.insertToRowline=o(this.insertToRowline,this),this.launchMobloggerAndCopy=o(this.launchMobloggerAndCopy,this),this.insertToMoblogger=o(this.insertToMoblogger,this),this.launchApp=o(this.launchApp,this),this.showPhoto=o(this.showPhoto,this),this.html=ko.computed(function(a){return function(){return a.htmlArray().join("")}}(this))}return a.prototype.afterListviewRender=function(a){return $(a).addClass("ui-li-has-thumb"),$(a).find("img").addClass("ui-li-thumb"),$("#preview").listview("refresh")},a.prototype.showPhoto=function(a){var b;return $.mobile.changePage("#preview-page",{transition:"slide"}),b=$(a).find("img").clone(),b.removeClass("ui-li-thumb"),b.removeAttr("height"),b.width("100%"),$("#img-preview").html(b)},a.prototype.launchApp=function(a){return $.mobile.changePage("#main"),window.location=a+encodeURIComponent(this.html())},a.prototype.insertToMoblogger=function(){return this.launchApp("moblogger://append?text=")},a.prototype.launchMobloggerAndCopy=function(){return this.launchApp("moblogger://pboard?text=")},a.prototype.insertToRowline=function(){return this.launchApp("rowline:///set?loc=bottom&view=lines&text=")},a.prototype.sendToTextHandler=function(){return this.launchApp("myscripts://run?title=TextHandler&text=")},a.prototype.insertToTextwell=function(){return T("add",{text:this.html()})},a}()}).call(this);